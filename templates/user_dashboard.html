<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <!-- PWA & Mobile safe meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, viewport-fit=cover">
  <meta name="theme-color" content="#0c0f15">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <title>User Dashboard | CCTV Alert System</title>

  <!-- manifest & icons -->
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" sizes="192x192" href="/static/icons/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="/static/icons/icon-512x512.png">

  <!-- main stylesheet -->
  <link rel="stylesheet" href="/static/css/style.css">

  <!-- firebase-config (root path as you requested) -->
  <script type="module" src="/firebase-config.js"></script>

  <!-- socket.io client lib -->
  <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>

  <!-- inline critical mobile-specific styles (keeps the main CSS in style.css) -->
  <style>
    /* small overrides for header/hamburger + layout safety */
    :root { --accent: #8a2be2; --accent-2: #00e5ff; }
    html,body{height:100%;margin:0;font-family: 'Segoe UI', Tahoma, Roboto, Arial; -webkit-font-smoothing:antialiased;}
    body {
      background: linear-gradient(160deg,#04070f,#0c1220);
      color:#e6eef8;
      overflow-x:hidden;
    }

    /* compact sticky header with hamburger (mobile-first) */
    .logo-header {
      position: sticky;
      top: 0;
      z-index: 1100;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:10px 16px;
      background: linear-gradient(180deg, rgba(5,7,10,0.93), rgba(10,12,18,0.85));
      backdrop-filter: blur(10px) saturate(1.1);
      border-bottom:1px solid rgba(255,255,255,0.03);
    }
    .hamburger-btn {
      position:absolute;
      left:14px;
      background:transparent;border:0;color:var(--accent-2);font-size:22px;padding:8px;cursor:pointer;border-radius:8px;
    }
    .hamburger-btn:active{transform:scale(.98)}
    .logo-center{display:flex;align-items:center;gap:10px;justify-content:center}
    .logo-center img{width:40px;height:40px;border-radius:8px;box-shadow:0 6px 18px rgba(138,43,226,.12);border:2px solid rgba(138,43,226,.08)}
    .logo-center .title{font-weight:800;font-size:15px;background:linear-gradient(135deg,var(--accent),var(--accent-2));-webkit-background-clip:text;color:transparent}

    .menu-dropdown{position:fixed;left:0;right:0;top:62px;z-index:1090;max-height:0;overflow:hidden;background:linear-gradient(180deg,rgba(6,8,12,.98),rgba(12,14,18,.98));backdrop-filter:blur(18px);border-bottom:1px solid rgba(138,43,226,.06);transition:max-height .28s ease;padding:0 12px}
    .menu-dropdown.show{max-height:260px;padding:12px}
    .menu-dropdown a{display:block;padding:12px 14px;border-radius:10px;text-decoration:none;color:#e8eef8;margin-bottom:8px;background:rgba(255,255,255,0.02);font-weight:700}
    .menu-dropdown a:active{transform:scale(.99);background:rgba(138,43,226,.08)}

    .container{max-width:1100px;margin:86px auto 48px;padding:12px;}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:16px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 30px rgba(0,0,0,.45)}
    .card h2{margin:0 0 12px;font-weight:800;letter-spacing:.2px;font-size:20px}
    .subtle{color:rgba(255,255,255,0.6);font-weight:600}

    .controls{display:grid;grid-template-columns:1fr;gap:10px}
    .input, .select{padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(0,0,0,0.15);color:#eaf2ff}
    .btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn-secondary{background:rgba(255,255,255,0.03);color:#eaf2ff;border:1px solid rgba(255,255,255,0.04)}
    .btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#081018}

    #alerts-list{margin-top:8px}
    .alert-card{background:transparent;border-radius:12px;padding:12px;margin:10px 0;border-left:4px solid rgba(255,255,255,0.04);display:flex;flex-direction:column;gap:6px}
    .alert-card .row-top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .alert-card .title{font-weight:800;font-size:15px}
    .alert-card .message{color:rgba(255,255,255,0.85);font-size:14px;margin:0}
    .alert-card .meta{color:rgba(255,255,255,0.55);font-size:12px}

    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:800;font-size:11px;color:#081018;background:linear-gradient(135deg,#f7c654,#ff8b60)}

    @media(min-width:700px){
      .container{margin-top:100px;padding:16px}
      .controls{grid-template-columns:repeat(2,1fr)}
      .menu-dropdown{left:14%;right:14%;top:72px;border-radius:12px}
    }

    a:focus, button:focus, .hamburger-btn:focus{outline:2px solid rgba(138,43,226,.18);outline-offset:2px}
  </style>
</head>
<body>
  <!-- Header (hamburger only) -->
  <header class="logo-header">
    <button class="hamburger-btn" id="hamburgerBtn" aria-label="Open menu">‚ò∞</button>
    <div class="logo-center" aria-hidden="false">
      <img src="/static/icons/icon-192x192.png" alt="CCTV Alerts">
      <div class="title">CCTV ALERTS</div>
    </div>
    <div style="width:44px"></div>
  </header>

  <!-- Dropdown menu -->
  <nav id="menuDropdown" class="menu-dropdown" aria-hidden="true">
    <a href="/user">üè† Live Alerts</a>
    <a href="/settings">‚öôÔ∏è Settings</a>
    <a href="/" onclick="logout(); return false;">üö™ Logout</a>
  </nav>

  <!-- Main content -->
  <main class="container" role="main">
    <!-- Live Alerts Card -->
    <section class="card" id="liveCard">
      <div style="display:flex;align-items:center;gap:12px">
        <h2 style="flex:1">üö® Live Alerts
          <span id="alert-count" class="badge" style="margin-left:8px;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#081018">0</span>
        </h2>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="sound-toggle" class="btn btn-secondary" title="Toggle sound">üîá</button>
        </div>
      </div>

      <div style="height:8px"></div>

      <div class="controls" style="margin-bottom:10px">
        <input id="filter-key" class="input" type="search" placeholder="Search‚Ä¶" aria-label="Search alerts">
        <select id="filter-priority" class="select" aria-label="Priority">
          <option value="">All</option>
          <option value="critical">Critical</option>
          <option value="high">High</option>
          <option value="medium">Medium</option>
          <option value="low">Low</option>
        </select>
        <div style="display:flex;gap:8px">
          <button class="btn btn-secondary" onclick="applyFilters()">Apply</button>
          <button class="btn btn-secondary" onclick="resetFilters()">Reset</button>
        </div>
      </div>

      <div id="alerts-list" aria-live="polite">
        <div style="text-align:center;color:rgba(255,255,255,0.55);padding:18px 0">
          üî≠ No alerts yet<br><small style="color:rgba(255,255,255,0.45)">You'll be notified when alerts are sent</small>
        </div>
      </div>
    </section>
  </main>

  <!-- load your socket wrapper (expects it to set global `socket`) -->
  <script src="/static/js/socket.js"></script>

  <!-- Service worker registration & FCM token logic -->
  <script>
    // Register service worker for FCM (root path)
    (async function registerSWAndFCM() {
      try {
        if ('serviceWorker' in navigator) {
          const reg = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
          console.log('‚úÖ FCM Service Worker registered at', reg.scope);
        } else {
          console.warn('ServiceWorker not supported');
        }
      } catch (err) {
        console.error('‚ùå FCM registration failed:', err);
      }
    })();
  </script>

  <!-- Full client logic: socket events, rendering, filters, sound, and FCM token saving -->
  <script>
    // Menu toggle
    const hamburger = document.getElementById('hamburgerBtn');
    const menu = document.getElementById('menuDropdown');
    hamburger.addEventListener('click', (e) => {
      e.stopPropagation();
      menu.classList.toggle('show');
      menu.setAttribute('aria-hidden', menu.classList.contains('show') ? 'false' : 'true');
    });
    // close when clicking outside
    document.addEventListener('click', (e) => {
      if (!menu.contains(e.target) && !hamburger.contains(e.target)) {
        menu.classList.remove('show');
        menu.setAttribute('aria-hidden','true');
      }
    });

    // Audio toggle + generator
    const soundToggle = document.getElementById('sound-toggle');
    let soundEnabled = false;
    soundToggle.addEventListener('click', () => {
      soundEnabled = !soundEnabled;
      soundToggle.textContent = soundEnabled ? 'üîä' : 'üîá';
      soundToggle.className = soundEnabled ? 'btn btn-primary' : 'btn btn-secondary';
      if (soundEnabled) playAlertSound();
    });

    function playAlertSound() {
      if (!soundEnabled) return;
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);
        o.frequency.value = 900;
        g.gain.setValueAtTime(0.25, ctx.currentTime);
        o.start();
        setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4); o.stop(ctx.currentTime + 0.45); }, 50);
      } catch (err) { console.error('Audio error', err) }
    }

    // Data store
    let ALL_ALERTS = [];

    // Helper: escape
    function escapeHtml(s = '') {
      return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
    }

    // Render utilities
    function addMinimalAlertCard(a) {
      const alertsList = document.getElementById('alerts-list');

      // clear "no alerts yet" placeholder if present
      if (alertsList.children.length === 1 && alertsList.textContent.trim().startsWith('üî≠')) {
        alertsList.innerHTML = '';
      }

      const card = document.createElement('div');
      card.className = 'alert-card priority-' + ((a.priority || 'medium').toLowerCase());
      card.innerHTML = `
        <div class="row-top">
          <div class="title">üö® ${escapeHtml(a.title || 'Alert')}</div>
          <div><span class="badge">${(a.priority || 'MEDIUM').toUpperCase()}</span></div>
        </div>
        <p class="message">${escapeHtml(a.message || '')}</p>
        <div class="meta">üìÖ ${new Date(a.timestamp).toLocaleString()}</div>
      `;
      alertsList.insertBefore(card, alertsList.firstChild);
      updateAlertCount();
    }

    function renderAlerts(list) {
      const alertsList = document.getElementById('alerts-list');
      alertsList.innerHTML = '';
      if (!list || !list.length) {
        alertsList.innerHTML = `<div style="text-align:center;color:rgba(255,255,255,0.55);padding:18px 0">üî≠ No alerts yet<br><small style="color:rgba(255,255,255,0.45)">You'll be notified when alerts are sent</small></div>`;
        updateAlertCount();
        return;
      }
      // insert in order (most recent first)
      list.forEach(a => addMinimalAlertCard(a));
    }

    function updateAlertCount() {
      const count = document.querySelectorAll('#alerts-list .alert-card').length;
      const el = document.getElementById('alert-count');
      if (el) el.textContent = count;
    }

    function applyFilters() {
      const key = (document.getElementById('filter-key').value || '').toLowerCase();
      const pr = (document.getElementById('filter-priority').value || '').toLowerCase();
      const filtered = ALL_ALERTS.filter(a => {
        const text = ((a.title||'') + ' ' + (a.message||'')).toLowerCase();
        const matchKey = key ? text.includes(key) : true;
        const matchPr = pr ? (a.priority||'').toLowerCase() === pr : true;
        return matchKey && matchPr;
      });
      renderAlerts(filtered);
    }

    function resetFilters() {
      document.getElementById('filter-key').value = '';
      document.getElementById('filter-priority').value = '';
      renderAlerts(ALL_ALERTS);
    }

    // Logout function (keeps same endpoint)
    async function logout() {
      localStorage.removeItem('role');
      try {
        await fetch('/api/logout', { method: 'POST', credentials: 'include' });
      } catch (e) { /* ignore */ }
      window.location.href = '/';
    }

    // Socket handling (this relies on your /static/js/socket.js exposing a global `socket`)
    if (typeof socket !== 'undefined') {
      socket.on('connect', () => {
        console.info('‚úÖ User dashboard connected to Socket.IO');
        // ask server for history if your socket.js expects this event
        try { socket.emit('userConnected'); } catch (e) {}
      });

      socket.on('disconnect', (reason) => {
        console.info('‚ùå User dashboard disconnected from Socket.IO', reason);
      });

      socket.on('alertHistory', (alerts) => {
        try {
          // server may send reverse or normal order; keep consistent by using as-is but render most recent first
          if (Array.isArray(alerts)) {
            // if alerts are saved in chronological order, reverse to show latest first
            ALL_ALERTS = alerts.slice();
            // prefer to show latest first:
            if (ALL_ALERTS.length && new Date(ALL_ALERTS[0].timestamp) < new Date(ALL_ALERTS[ALL_ALERTS.length-1].timestamp)) {
              ALL_ALERTS.reverse();
            }
          } else {
            ALL_ALERTS = [];
          }
          renderAlerts(ALL_ALERTS);
        } catch (err) { console.error('alertHistory error', err); }
      });

      socket.on('newAlert', (alert) => {
        try {
          if (!alert) return;
          // dedupe if id present
          if (alert.id) {
            if (ALL_ALERTS.some(a => a.id === alert.id)) return;
          }
          ALL_ALERTS.unshift(alert);
          addMinimalAlertCard(alert);
          if (soundEnabled) playAlertSound();
        } catch (err) { console.error('newAlert handling error', err); }
      });

    } else {
      console.warn('socket variable not found. Ensure /static/js/socket.js is loaded and sets `socket` globally.');
    }

    // Fallback initial load via REST API (in case socket didn't supply history)
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const res = await fetch('/api/alerts', { credentials: 'include' });
        const data = await res.json();
        if (data.ok && Array.isArray(data.alerts)) {
          ALL_ALERTS = data.alerts;
          renderAlerts(ALL_ALERTS);
        }
      } catch (err) {
        console.warn('Could not fetch initial alerts via API (socket will still work).', err);
      }
    });

    /***********************
     * FCM token / permission helper
     *
     * This code assumes your /firebase-config.js (root) initializes Firebase messaging
     * and exposes logic to request permission and obtain a token (modular SDK).
     * If you used the earlier modular code snippet in the project, please ensure
     * it calls a window-level function or handles sending the token to /api/save-fcm-token itself.
     *
     * We include a fallback helper to post a token to your server endpoint here.
     ***********************/
    async function saveFcmTokenToServer(token) {
      try {
        const resp = await fetch('/api/save-fcm-token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ token })
        });
        if (resp.ok) console.log('üì± Token sent to server successfully!');
        else console.warn('‚ö†Ô∏è Failed to send token to server:', resp.status);
      } catch (err) {
        console.error('‚ùå Error sending token to server:', err);
      }
    }

    // If your firebase-config.js exposes a function to register and return a token, call it:
    // e.g. window.requestFcmToken().then(token => saveFcmTokenToServer(token)).catch(...)
    // If firebase-config.js already posts token to server, no need to run anything here.

  </script>
</body>
</html>
